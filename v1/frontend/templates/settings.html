{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Settings</h2>
  <p class="muted">Update directories and Ollama options. Values are saved via the Config API.</p>
  <form id="settings-form">
    <div class="settings-section">
      <label>Uploads dir<br><input type="text" id="uploads_dir" name="uploads_dir" value="{{ config.uploads_dir if config else '' }}"></label><br>
      <label>Temp dir<br><input type="text" id="temp_dir" name="temp_dir" value="{{ config.temp_dir if config else '' }}"></label><br>
      <label>Data dir<br><input type="text" id="data_dir" name="data_dir" value="{{ config.data_dir if config else '' }}"></label><br>
      <label>DB path<br><input type="text" id="database_path" name="database_path" value="{{ config.database_path if config else '' }}"></label><br>
    </div>
    <hr>
    <div class="settings-section">
      <div class="helper-row">
        <label style="flex:1;">KiCad root (optional)<br><input type="text" id="kicad_root_dir" name="kicad_root_dir" value="{{ config.kicad_root_dir if config and config.kicad_root_dir else '' }}" placeholder="/path/to/kicad"></label>
        <button type="button" id="apply-kicad-root">Change paths</button>
      </div>
      <label>Symbol dir<br><input type="text" id="kicad_symbol_dir" name="kicad_symbol_dir" value="{{ config.kicad_symbol_dir if config else '' }}"></label><br>
      <label>Footprint dir<br><input type="text" id="kicad_footprint_dir" name="kicad_footprint_dir" value="{{ config.kicad_footprint_dir if config else '' }}"></label><br>
      <label>3D dir<br><input type="text" id="kicad_3d_dir" name="kicad_3d_dir" value="{{ config.kicad_3d_dir if config else '' }}"></label><br>
    </div>
    <hr>
    <div class="settings-section">
      <label><input type="checkbox" id="ollama_enabled" name="ollama_enabled" {% if config and config.ollama_enabled %}checked{% endif %}> Ollama enabled</label><br>
      <div class="helper-row">
        <label style="flex:1;">Ollama base URL<br><input type="text" id="ollama_base_url" name="ollama_base_url" value="{{ config.ollama_base_url if config else '' }}" placeholder="Use a reachable address from this container (e.g., http://192.168.20.3:11434 or http://host.docker.internal:11434)."></label>
        <button type="button" id="ollama-test">Test Ollama</button>
      </div>
      <p class="muted"></p>
      <p id="ollama-test-status" class="muted"></p>
      <label>Ollama model<br><input type="text" id="ollama_model" name="ollama_model" list="ollama-models" value="{{ config.ollama_model if config else '' }}"></label>
      <datalist id="ollama-models"></datalist>
      <div class="option-stack" id="ollama-model-stack">
      <div class="card-header small helper-row">
        <h4 style="margin: 0;">Available models</h4>
        <button type="button" id="refresh-models">Reload models</button>
      </div>
      <select id="ollama-model-select" class="select-input" size="6"></select>
    </div>
    <p id="ollama-model-hint" class="muted"></p>
    </div>
    <hr>
    <div class="settings-section">
      <label>Log level<br><input type="text" id="log_level" name="log_level" value="{{ config.log_level if config else 'INFO' }}"></label><br>
      <label>Log file (optional)<br><input type="text" id="log_file" name="log_file" value="{{ config.log_file if config and config.log_file else '' }}"></label><br>
    </div>
    <hr>
    <div class="helper-row">
      <button type="submit">Save Settings</button>
    </div>
  </form>
  <p id="settings-status" class="muted"></p>
</section>
<script>
  const form = document.getElementById('settings-form');
  const statusEl = document.getElementById('settings-status');
  const modelList = document.getElementById('ollama-models');
  const modelHint = document.getElementById('ollama-model-hint');
  const baseInput = document.getElementById('ollama_base_url');
  const modelInput = document.getElementById('ollama_model');
  const enabledBox = document.getElementById('ollama_enabled');
  const modelSelect = document.getElementById('ollama-model-select');
  const modelStack = document.getElementById('ollama-model-stack');
  const kicadRootInput = document.getElementById('kicad_root_dir');
  const symbolInput = document.getElementById('kicad_symbol_dir');
  const footprintInput = document.getElementById('kicad_footprint_dir');
  const modelDirInput = document.getElementById('kicad_3d_dir');

  function buildPayload() {
    const formData = new FormData(form);
    const payload = {};
    formData.forEach((value, key) => {
      if (key === "ollama_enabled") {
        payload[key] = true;
      } else if (value !== "") {
        payload[key] = value;
      }
    });
    if (!payload["ollama_enabled"]) payload["ollama_enabled"] = false;
    return payload;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = buildPayload();
    statusEl.textContent = "Saving settings...";
    try {
      const resp = await fetch("/api/config", {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload),
      });
      const body = await resp.json();
      statusEl.textContent = "Saved settings.";
      if (body.ollama_base_url) {
        baseInput.value = body.ollama_base_url;
      }
      if (body.ollama_model) {
        modelInput.value = body.ollama_model;
      }
    } catch (err) {
      statusEl.textContent = "Save failed: " + (err?.message || err);
    }
  });

  async function loadModels() {
    const baseUrl = baseInput.value.trim();
    if (!baseUrl) {
      modelHint.textContent = "Enter an Ollama base URL to load models.";
      modelList.innerHTML = "";
      document.getElementById('model-list-display').innerHTML = "";
      modelSelect.innerHTML = "";
      modelStack.hidden = true;
      return;
    }
    modelHint.textContent = "Loading available models...";
    try {
      const resp = await fetch(`/api/ollama/models?base_url=${encodeURIComponent(baseUrl)}`);
      const body = await resp.json();
      if (!resp.ok) {
        throw new Error(body.detail || "Request failed");
      }
      modelList.innerHTML = "";
      modelSelect.innerHTML = "";
      (body.models || []).forEach((name) => {
        const opt = document.createElement('option');
        opt.value = name;
        modelList.appendChild(opt);
        const optSelect = document.createElement('option');
        optSelect.value = name;
        optSelect.textContent = name;
        modelSelect.appendChild(optSelect);
      });
      if (modelSelect.options.length) {
        modelSelect.size = Math.min(12, Math.max(3, modelSelect.options.length));
        modelStack.hidden = false;
      } else {
        modelStack.hidden = true;
      }
      modelHint.textContent = (body.models && body.models.length)
        ? `Loaded ${body.models.length} model option(s). Click a chip to select.`
        : "No models reported by Ollama. Check the base URL and network.";
    } catch (err) {
      modelHint.textContent = "Model list unavailable: " + (err?.message || err);
    }
  }

  const ollamaTestStatus = document.getElementById('ollama-test-status');

  document.getElementById('ollama-test').addEventListener('click', async () => {
    const enabled = enabledBox.checked;
    const baseUrl = baseInput.value.trim();
    const model = modelInput.value.trim();
    if (!baseUrl || !model) {
      statusEl.textContent = "Set base URL and model to run the test.";
      return;
    }
    statusEl.textContent = "Running Ollama test...";
    const params = new URLSearchParams({ enabled: String(enabled), base_url: baseUrl, model });
    try {
      const resp = await fetch(`/api/ollama/test?${params.toString()}`);
      const body = await resp.json();
      if (!resp.ok) {
        statusEl.textContent = "Ollama test failed: " + (body.detail || resp.statusText);
        return;
      }
      if (body.enabled === false) {
        statusEl.textContent = "Enable Ollama and save before testing.";
        return;
      }
      const msg = body.ok
        ? `Ollama OK via ${body.base_url} using ${body.model}`
        : `Ollama test failed: ${body.error || "unknown error"}. Requested URL: ${body.requested_url || "n/a"}`;
      statusEl.textContent = msg;
      if (ollamaTestStatus) {
        ollamaTestStatus.textContent = msg;
      }
    } catch (err) {
      const msg = "Ollama test failed: " + (err?.message || err);
      statusEl.textContent = msg;
      if (ollamaTestStatus) {
        ollamaTestStatus.textContent = msg;
      }
    }
  });

  loadModels();
  baseInput?.addEventListener('change', loadModels);
  document.getElementById('refresh-models').addEventListener('click', loadModels);
  modelSelect?.addEventListener('change', () => {
    if (modelSelect.value) {
      modelInput.value = modelSelect.value;
    }
  });
  document.getElementById('apply-kicad-root')?.addEventListener('click', () => {
    const root = (kicadRootInput?.value || "").trim().replace(/\/+$/, "");
    if (!root) return;
    if (symbolInput) symbolInput.value = `${root}/symbols`;
    if (footprintInput) footprintInput.value = `${root}/footprints`;
    if (modelDirInput) modelDirInput.value = `${root}/3d`;
  });
</script>
{% endblock %}
