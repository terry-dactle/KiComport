{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Job #{{ job.id }} â€” {{ job.original_filename }}</h2>
  <p>Status: <span class="badge {{ job.status.value }}"><span class="badge-dot"></span>{{ job.status.value.replace("_", " ") }}</span></p>
  <p>MD5: <span class="mono">{{ job.md5 }}</span></p>
  <p>Message: {{ job.message or "-" }}</p>
  <div class="actions">
    {% if job.status.value == "error" %}
      <button id="retry-job">Retry</button>
      <button id="delete-job" class="danger">Remove</button>
    {% endif %}
  </div>
  <p id="job-action-status" class="muted"></p>
</section>

<section class="card">
  <h3>Components & Candidates</h3>
{% if job.components %}
  <form id="selection-form">
    {% for comp in job.components %}
      <input type="hidden" name="symbol_{{ comp.id }}" value="{{ comp.selected_symbol_id or '' }}">
      <input type="hidden" name="footprint_{{ comp.id }}" value="{{ comp.selected_footprint_id or '' }}">
      <input type="hidden" name="model_{{ comp.id }}" value="{{ comp.selected_model_id or '' }}">
    {% endfor %}

    <div class="grid three-col align-start candidate-columns">
      <div class="candidate-card">
        <div class="card-header small"><h4>Symbols</h4></div>
        {% set any_symbols = false %}
        {% for comp in job.components %}
          {% set cands = comp.candidates | selectattr('type.value', 'equalto', 'symbol') | sort(attribute='combined_score', reverse=True) | list %}
          {% if cands %}
            {% set any_symbols = true %}
            <div class="component-block">
              <h5>{{ comp.name }}</h5>
              <div class="chip-list">
                {% for cand in cands %}
                <div class="chip selectable-chip" data-input="symbol_{{ comp.id }}" data-value="{{ cand.id }}">
                  <div class="title">{{ cand.name }}</div>
                  <div class="meta">Score {{ "%.2f"|format(cand.combined_score) }} | Pins {{ cand.pin_count or "-" }}</div>
                </div>
                {% endfor %}
                <div class="chip selectable-chip none-option" data-input="symbol_{{ comp.id }}" data-value="">None</div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
        {% if not any_symbols %}
          <p class="muted">No symbol candidates.</p>
        {% endif %}
      </div>

      <div class="candidate-card">
        <div class="card-header small"><h4>Footprints</h4></div>
        {% set any_fps = false %}
        {% for comp in job.components %}
          {% set cands = comp.candidates | selectattr('type.value', 'equalto', 'footprint') | sort(attribute='combined_score', reverse=True) | list %}
          {% if cands %}
            {% set any_fps = true %}
            <div class="component-block">
              <h5>{{ comp.name }}</h5>
              <div class="chip-list">
                {% for cand in cands %}
                <div class="chip selectable-chip" data-input="footprint_{{ comp.id }}" data-value="{{ cand.id }}">
                  <div class="title">{{ cand.name }}</div>
                  <div class="meta">Score {{ "%.2f"|format(cand.combined_score) }} | Pads {{ cand.pad_count or "-" }}</div>
                  <div class="muted mono small">{{ cand.rel_path }}</div>
                </div>
                {% endfor %}
                <div class="chip selectable-chip none-option" data-input="footprint_{{ comp.id }}" data-value="">None</div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
        {% if not any_fps %}
          <p class="muted">No footprint candidates.</p>
        {% endif %}
      </div>

      <div class="candidate-card">
        <div class="card-header small"><h4>3D Models</h4></div>
        {% set any_models = false %}
        {% for comp in job.components %}
          {% set cands = comp.candidates | selectattr('type.value', 'equalto', 'model') | sort(attribute='combined_score', reverse=True) | list %}
          {% if cands %}
            {% set any_models = true %}
            <div class="component-block">
              <h5>{{ comp.name }}</h5>
              <div class="chip-list">
                {% for cand in cands %}
                <div class="chip selectable-chip" data-input="model_{{ comp.id }}" data-value="{{ cand.id }}">
                  <div class="title">{{ cand.name }}</div>
                  <div class="meta">Score {{ "%.2f"|format(cand.combined_score) }} | {{ cand.description or "-" }}</div>
                  <div class="muted mono small">{{ cand.rel_path }}</div>
                </div>
                {% endfor %}
                <div class="chip selectable-chip none-option" data-input="model_{{ comp.id }}" data-value="">None</div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
        {% if not any_models %}
          <p class="muted">No 3D model candidates.</p>
        {% endif %}
      </div>
    </div>

    <div class="card actions-card">
      <h4>Save & Import</h4>
      <div class="actions">
        <button type="submit">Save</button>
        <button type="button" id="import-btn">Save and Import</button>
      </div>
    </div>
  </form>
{% else %}
  <p>No components found.</p>
{% endif %}
</section>

<section class="card">
  <h3>Logs</h3>
  {% if job.logs %}
  <ul class="logs">
    {% for log in job.logs %}
    <li><span class="mono">{{ log.created_at.strftime("%Y-%m-%d %H:%M") }}</span> [{{ log.level }}] {{ log.message }}</li>
    {% endfor %}
  </ul>
  {% else %}
  <p>No logs yet.</p>
  {% endif %}
</section>

<script>
  const jobId = {{ job.id }};
  const actionStatus = document.getElementById('job-action-status');
  const retryBtn = document.getElementById('retry-job');
  const deleteBtn = document.getElementById('delete-job');
  function setActionStatus(msg) { if (actionStatus) actionStatus.textContent = msg; }

  retryBtn?.addEventListener('click', async () => {
    setActionStatus("Retrying...");
    try {
      const resp = await fetch(`/api/jobs/${jobId}/retry`, { method: "POST" });
      const body = await resp.json();
      if (!resp.ok) throw new Error(body.detail || resp.statusText);
      setActionStatus("Retry kicked off. Reloading...");
      window.location.reload();
    } catch (err) {
      setActionStatus(`Retry failed: ${err?.message || err}`);
    }
  });

  deleteBtn?.addEventListener('click', async () => {
    if (!confirm("Remove this job and its files?")) return;
    setActionStatus("Removing...");
    try {
      const resp = await fetch(`/api/jobs/${jobId}`, { method: "DELETE" });
      if (!resp.ok) {
        const body = await resp.json().catch(() => ({}));
        throw new Error(body.detail || resp.statusText);
      }
      window.location.href = "/";
    } catch (err) {
      setActionStatus(`Remove failed: ${err?.message || err}`);
    }
  });
  async function saveSelections() {
    const form = document.getElementById('selection-form');
    if (!form) return { ok: false, message: "No form present" };
    const data = {};
    {% for comp in job.components %}
    data["{{ comp.id }}"] = {
      symbol_id: form["symbol_{{ comp.id }}"]?.value || null,
      footprint_id: form["footprint_{{ comp.id }}"]?.value || null,
      model_id: form["model_{{ comp.id }}"]?.value || null,
    };
    {% endfor %}
    const resp = await fetch(`/api/jobs/${jobId}/select`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    });
    const body = await resp.json();
    return { ok: resp.ok, body, message: body.detail || "" };
  }

  function attachSelectableHandlers() {
    document.querySelectorAll('.selectable-chip').forEach((item) => {
      item.addEventListener('click', () => {
        const inputName = item.getAttribute('data-input');
        const val = item.getAttribute('data-value');
        const hidden = document.querySelector(`input[name="${inputName}"]`);
        if (hidden) hidden.value = val || "";
        // clear selection in same group
        document.querySelectorAll(`.selectable-chip[data-input="${inputName}"]`).forEach((el) => el.classList.remove('selected'));
        item.classList.add('selected');
      });
    });
    // preselect existing values
    document.querySelectorAll('.selectable-chip').forEach((item) => {
      const inputName = item.getAttribute('data-input');
      const val = item.getAttribute('data-value');
      const hidden = document.querySelector(`input[name="${inputName}"]`);
      if (hidden && hidden.value === val) {
        item.classList.add('selected');
      }
    });
  }
  attachSelectableHandlers();

  document.getElementById('selection-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    setActionStatus("Saving choices...");
    try {
      const result = await saveSelections();
      if (!result.ok) throw new Error(result.message || "Failed to save choices");
      setActionStatus("Choices saved.");
    } catch (err) {
      setActionStatus(`Save failed: ${err?.message || err}`);
    }
  });

  document.getElementById('import-btn')?.addEventListener('click', async () => {
    setActionStatus("Saving choices before import...");
    try {
      const saved = await saveSelections();
      if (!saved.ok) throw new Error(saved.message || "Failed to save choices");
      setActionStatus("Importing to KiCad...");
      const resp = await fetch(`/api/jobs/${jobId}/import`, { method: "POST" });
      const body = await resp.json();
      if (!resp.ok) throw new Error(body.detail || body.error || resp.statusText);
      setActionStatus("Import complete.");
      alert("Import complete.");
    } catch (err) {
      setActionStatus(`Import failed: ${err?.message || err}`);
    }
  });
</script>
{% endblock %}
