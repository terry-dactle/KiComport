{% extends "base.html" %}
{% block content %}
<section class="card">
  <h2>Job #{{ job.id }} — {{ job.original_filename }}</h2>
  <p>Status: <span class="badge {{ job.status.value }}"><span class="badge-dot"></span>{{ job.status.value.replace("_", " ") }}</span></p>
  <p>MD5: <span class="mono">{{ job.md5 }}</span></p>
  <p>Message: {{ job.message or "-" }}</p>
  <div class="actions">
    {% if job.status.value == "error" %}
      <button id="retry-job">Retry</button>
      <button id="delete-job" class="danger">Remove</button>
    {% endif %}
  </div>
  <p id="job-action-status" class="muted"></p>
</section>

<section class="card">
  <h3>Components & Candidates</h3>
{% if job.components %}
  {% set symbols = namespace(options=[]) %}
  {% set footprints = namespace(options=[]) %}
  {% set models = namespace(options=[]) %}
  {% set selected_symbol = namespace(id=None, comp=None) %}
  {% set selected_footprint = namespace(id=None, comp=None) %}
  {% set selected_model = namespace(id=None, comp=None) %}
  {% for comp in job.components %}
    {% if comp.selected_symbol_id and not selected_symbol.id %}
      {% set selected_symbol.id = comp.selected_symbol_id %}
      {% set selected_symbol.comp = comp.id %}
    {% endif %}
    {% if comp.selected_footprint_id and not selected_footprint.id %}
      {% set selected_footprint.id = comp.selected_footprint_id %}
      {% set selected_footprint.comp = comp.id %}
    {% endif %}
    {% if comp.selected_model_id and not selected_model.id %}
      {% set selected_model.id = comp.selected_model_id %}
      {% set selected_model.comp = comp.id %}
    {% endif %}
    {% for cand in comp.candidates | sort(attribute='combined_score', reverse=True) %}
      {% if cand.type.value == 'symbol' %}
        {% set _ = symbols.options.append({"id": cand.id, "name": cand.name, "comp_id": comp.id, "comp_name": comp.name, "score": cand.combined_score, "pins": cand.pin_count, "path": cand.rel_path, "file": cand.rel_path.name if cand.rel_path else cand.name}) %}
      {% elif cand.type.value == 'footprint' %}
        {% set _ = footprints.options.append({"id": cand.id, "name": cand.name, "comp_id": comp.id, "comp_name": comp.name, "score": cand.combined_score, "pads": cand.pad_count, "path": cand.rel_path, "file": cand.rel_path.name if cand.rel_path else cand.name}) %}
      {% elif cand.type.value == 'model' %}
        {% set _ = models.options.append({"id": cand.id, "name": cand.name, "comp_id": comp.id, "comp_name": comp.name, "score": cand.combined_score, "desc": cand.description, "path": cand.rel_path, "file": cand.rel_path.name if cand.rel_path else cand.name}) %}
      {% endif %}
    {% endfor %}
  {% endfor %}
  <form id="selection-form">
    <div id="selection-hidden-inputs" hidden>
      {% for comp in job.components %}
        <input type="hidden" name="symbol_{{ comp.id }}" value="{{ comp.selected_symbol_id or '' }}">
        <input type="hidden" name="footprint_{{ comp.id }}" value="{{ comp.selected_footprint_id or '' }}">
        <input type="hidden" name="model_{{ comp.id }}" value="{{ comp.selected_model_id or '' }}">
      {% endfor %}
    </div>
    <div class="muted small">Pick one choice per type. Choosing an option fills that component and clears the rest for that type. Scroll inside each card to see all options.</div>
    <div class="grid three-col align-start candidate-columns">
      <div class="candidate-card">
        <div class="card-header small">
          <h4>Symbols</h4>
          <span class="count-pill">{{ symbols.options|length }} option{{ '' if symbols.options|length == 1 else 's' }}</span>
        </div>
        <div class="option-stack" data-type="symbol">
          {% if symbols.options %}
            {% for opt in symbols.options | sort(attribute='score', reverse=True) %}
              <button type="button" class="option-tile {% if opt.id == selected_symbol.id %}selected{% endif %}" data-type="symbol" data-cand-id="{{ opt.id }}" data-comp-id="{{ opt.comp_id }}" data-path="{{ opt.path }}" data-file="{{ opt.file }}" data-name="{{ opt.name }}">
                <div class="option-head">
                  <div class="option-name">{{ opt.name }}</div>
                  {% if opt.comp_name != opt.name %}<div class="option-tag">{{ opt.comp_name }}</div>{% endif %}
                </div>
                <div class="option-meta-row">
                  <span class="meta-chip">Score {{ "%.2f"|format(opt.score or 0) }}</span>
                  <span class="meta-chip">Pins {{ opt.pins or "-" }}</span>
                </div>
                {% if opt.file %}<div class="option-file mono small">{{ opt.file }}</div>{% endif %}
                {% if opt.path %}<div class="option-path mono small">{{ opt.path }}</div>{% endif %}
              </button>
            {% endfor %}
          {% else %}
            <p class="muted">No symbol candidates.</p>
          {% endif %}
          <button type="button" class="option-tile none" data-type="symbol" data-cand-id="">
            None
          </button>
        </div>
        <div class="viewer-panel" id="viewer-symbol">Hover a symbol to preview its path.</div>
      </div>

      <div class="candidate-card">
        <div class="card-header small">
          <h4>Footprints</h4>
          <span class="count-pill">{{ footprints.options|length }} option{{ '' if footprints.options|length == 1 else 's' }}</span>
        </div>
        <div class="option-stack" data-type="footprint">
          {% if footprints.options %}
            {% for opt in footprints.options | sort(attribute='score', reverse=True) %}
              <button type="button" class="option-tile {% if opt.id == selected_footprint.id %}selected{% endif %}" data-type="footprint" data-cand-id="{{ opt.id }}" data-comp-id="{{ opt.comp_id }}" data-path="{{ opt.path }}" data-file="{{ opt.file }}" data-name="{{ opt.name }}">
                <div class="option-head">
                  <div class="option-name">{{ opt.name }}</div>
                  {% if opt.comp_name != opt.name %}<div class="option-tag">{{ opt.comp_name }}</div>{% endif %}
                </div>
                <div class="option-meta-row">
                  <span class="meta-chip">Score {{ "%.2f"|format(opt.score or 0) }}</span>
                  <span class="meta-chip">Pads {{ opt.pads or "-" }}</span>
                </div>
                {% if opt.file %}<div class="option-file mono small">{{ opt.file }}</div>{% endif %}
                {% if opt.path %}<div class="option-path mono small">{{ opt.path }}</div>{% endif %}
              </button>
            {% endfor %}
          {% else %}
            <p class="muted">No footprint candidates.</p>
          {% endif %}
          <button type="button" class="option-tile none" data-type="footprint" data-cand-id="">
            None
          </button>
        </div>
        <div class="viewer-panel" id="viewer-footprint">Hover a footprint to preview its path.</div>
      </div>

      <div class="candidate-card">
        <div class="card-header small">
          <h4>3D Models</h4>
          <span class="count-pill">{{ models.options|length }} option{{ '' if models.options|length == 1 else 's' }}</span>
        </div>
        <div class="option-stack" data-type="model">
          {% if models.options %}
            {% for opt in models.options | sort(attribute='score', reverse=True) %}
              <button type="button" class="option-tile {% if opt.id == selected_model.id %}selected{% endif %}" data-type="model" data-cand-id="{{ opt.id }}" data-comp-id="{{ opt.comp_id }}" data-path="{{ opt.path }}" data-file="{{ opt.file }}" data-name="{{ opt.name }}">
                <div class="option-head">
                  <div class="option-name">{{ opt.name }}</div>
                  {% if opt.comp_name != opt.name %}<div class="option-tag">{{ opt.comp_name }}</div>{% endif %}
                </div>
                <div class="option-meta-row">
                  <span class="meta-chip">Score {{ "%.2f"|format(opt.score or 0) }}</span>
                  <span class="meta-chip">{{ opt.desc or "-" }}</span>
                </div>
                {% if opt.file %}<div class="option-file mono small">{{ opt.file }}</div>{% endif %}
                {% if opt.path %}<div class="option-path mono small">{{ opt.path }}</div>{% endif %}
              </button>
            {% endfor %}
          {% else %}
            <p class="muted">No 3D model candidates.</p>
          {% endif %}
          <button type="button" class="option-tile none" data-type="model" data-cand-id="">
            None
          </button>
        </div>
        <div class="viewer-panel" id="viewer-model">Hover a model to preview its path.</div>
      </div>
    </div>

    <div class="card actions-card">
      <h4>Save & Import</h4>
      <div class="actions">
        <button type="submit">Save</button>
        <button type="button" id="import-btn">Save and Import</button>
      </div>
    </div>
  </form>
{% else %}
  <p>No components found.</p>
{% endif %}
</section>

<section class="card">
  <h3>Logs</h3>
  {% if job.logs %}
  <ul class="logs">
    {% for log in job.logs %}
    <li><span class="mono">{{ log.created_at.strftime("%Y-%m-%d %H:%M") }}</span> [{{ log.level }}] {{ log.message }}</li>
    {% endfor %}
  </ul>
  {% else %}
  <p>No logs yet.</p>
  {% endif %}
</section>

<script>
  const jobId = {{ job.id }};
  const actionStatus = document.getElementById('job-action-status');
  const retryBtn = document.getElementById('retry-job');
  const deleteBtn = document.getElementById('delete-job');
  function setActionStatus(msg) { if (actionStatus) actionStatus.textContent = msg; }

  retryBtn?.addEventListener('click', async () => {
    setActionStatus("Retrying...");
    try {
      const resp = await fetch(`/api/jobs/${jobId}/retry`, { method: "POST" });
      const body = await resp.json();
      if (!resp.ok) throw new Error(body.detail || resp.statusText);
      setActionStatus("Retry kicked off. Reloading...");
      window.location.reload();
    } catch (err) {
      setActionStatus(`Retry failed: ${err?.message || err}`);
    }
  });

  deleteBtn?.addEventListener('click', async () => {
    if (!confirm("Remove this job and its files?")) return;
    setActionStatus("Removing...");
    try {
      const resp = await fetch(`/api/jobs/${jobId}`, { method: "DELETE" });
      if (!resp.ok) {
        const body = await resp.json().catch(() => ({}));
        throw new Error(body.detail || resp.statusText);
      }
      window.location.href = "/";
    } catch (err) {
      setActionStatus(`Remove failed: ${err?.message || err}`);
    }
  });
  async function saveSelections() {
    const form = document.getElementById('selection-form');
    if (!form) return { ok: false, message: "No form present" };
    const data = {};
    const symbolMap = {};
    const footprintMap = {};
    const modelMap = {};
    document.querySelectorAll('input[name^="symbol_"]').forEach((hidden) => { symbolMap[hidden.name.replace("symbol_", "")] = hidden.value || null; });
    document.querySelectorAll('input[name^="footprint_"]').forEach((hidden) => { footprintMap[hidden.name.replace("footprint_", "")] = hidden.value || null; });
    document.querySelectorAll('input[name^="model_"]').forEach((hidden) => { modelMap[hidden.name.replace("model_", "")] = hidden.value || null; });
    {% for comp in job.components %}
    data["{{ comp.id }}"] = {
      symbol_id: symbolMap["{{ comp.id }}"] || null,
      footprint_id: footprintMap["{{ comp.id }}"] || null,
      model_id: modelMap["{{ comp.id }}"] || null,
    };
    {% endfor %}
    const resp = await fetch(`/api/jobs/${jobId}/select`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    });
    const body = await resp.json();
    return { ok: resp.ok, body, message: body.detail || "" };
  }

  function applyTypeSelection(type, candId, compId) {
    document.querySelectorAll(`input[name^="${type}_"]`).forEach((hidden) => { hidden.value = ""; });
    if (candId && compId) {
      const target = document.querySelector(`input[name="${type}_${compId}"]`);
      if (target) target.value = candId;
    }
  }

  function markSelected(type, activeBtn) {
    document.querySelectorAll(`.option-tile[data-type="${type}"]`).forEach((btn) => {
      btn.classList.toggle('selected', btn === activeBtn);
    });
  }

  const viewers = {
    symbol: document.getElementById('viewer-symbol'),
    footprint: document.getElementById('viewer-footprint'),
    model: document.getElementById('viewer-model'),
  };

  function setPreview(type, btn) {
    const viewer = viewers[type];
    if (!viewer) return;
    if (!btn) {
      viewer.textContent = `Hover a ${type} to preview its path.`;
      return;
    }
    const name = btn.dataset.name || "Unknown";
    const file = btn.dataset.file || "";
    const path = btn.dataset.path || "";
    const meta = [name, file, path].filter(Boolean).join(" — ");
    viewer.textContent = meta || "No preview available";
  }

  function initOptionTiles() {
    document.querySelectorAll('.option-tile').forEach((btn) => {
      btn.addEventListener('click', () => {
        const type = btn.dataset.type;
        applyTypeSelection(type, btn.dataset.candId || "", btn.dataset.compId || "");
        markSelected(type, btn);
        setPreview(type, btn);
      });
      btn.addEventListener('mouseenter', () => setPreview(btn.dataset.type, btn));
      btn.addEventListener('mouseleave', () => setPreview(btn.dataset.type, null));
    });
    ["symbol", "footprint", "model"].forEach((type) => {
      const active = document.querySelector(`.option-tile[data-type="${type}"].selected`);
      if (active) {
        applyTypeSelection(type, active.dataset.candId || "", active.dataset.compId || "");
        return;
      }
      let chosen = null;
      document.querySelectorAll(`input[name^="${type}_"]`).forEach((hidden) => {
        if (!chosen && hidden.value) {
          chosen = document.querySelector(`.option-tile[data-type="${type}"][data-cand-id="${hidden.value}"]`);
        }
      });
      if (chosen) {
        markSelected(type, chosen);
        applyTypeSelection(type, chosen.dataset.candId || "", chosen.dataset.compId || "");
        return;
      }
      const firstCandidate = document.querySelector(`.option-tile[data-type="${type}"]:not(.none)`);
      if (firstCandidate) {
        markSelected(type, firstCandidate);
        applyTypeSelection(type, firstCandidate.dataset.candId || "", firstCandidate.dataset.compId || "");
        return;
      }
      const noneBtn = document.querySelector(`.option-tile.none[data-type="${type}"]`);
      if (noneBtn) {
        markSelected(type, noneBtn);
        applyTypeSelection(type, "", "");
      }
    });
  }
  initOptionTiles();

  document.getElementById('selection-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    setActionStatus("Saving choices...");
    try {
      const result = await saveSelections();
      if (!result.ok) throw new Error(result.message || "Failed to save choices");
      setActionStatus("Choices saved.");
    } catch (err) {
      setActionStatus(`Save failed: ${err?.message || err}`);
    }
  });

  document.getElementById('import-btn')?.addEventListener('click', async () => {
    setActionStatus("Saving choices before import...");
    try {
      const saved = await saveSelections();
      if (!saved.ok) throw new Error(saved.message || "Failed to save choices");
      setActionStatus("Importing to KiCad...");
      const resp = await fetch(`/api/jobs/${jobId}/import`, { method: "POST" });
      const body = await resp.json();
      if (!resp.ok) throw new Error(body.detail || body.error || resp.statusText);
      setActionStatus("Import complete.");
      alert("Import complete.");
    } catch (err) {
      setActionStatus(`Import failed: ${err?.message || err}`);
    }
  });
</script>
{% endblock %}
