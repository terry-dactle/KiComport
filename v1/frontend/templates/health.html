{% extends "base.html" %}
{% block content %}
<section class="card">
  <div class="card-header">
    <div>
      <h2>Health</h2>
      <p class="muted">Backend liveness pulled from <code>/health</code>. Use this to confirm the service is up.</p>
    </div>
    <button type="button" id="health-refresh">Re-run check</button>
  </div>
  <div class="status-row" id="health-status">
    <div class="status-dot {{ 'ok' if health and health.status == 'ok' else 'err' }}"></div>
    <div>
      <div class="status-title">{{ health.status.upper() if health and health.status else "UNKNOWN" }}</div>
      <div class="muted">Timestamp {{ health.timestamp if health and health.timestamp else "not available" }}</div>
    </div>
  </div>
  <pre class="config-dump" id="health-json">{{ health | tojson(indent=2) if health else '{}' }}</pre>
</section>
<script>
  const refreshBtn = document.getElementById('health-refresh');
  const statusRow = document.getElementById('health-status');
  const dot = statusRow.querySelector('.status-dot');
  const titleEl = statusRow.querySelector('.status-title');
  const tsEl = statusRow.querySelector('.muted');
  const jsonEl = document.getElementById('health-json');

  function setStatus(data) {
    const ok = data.status && data.status.toLowerCase() === "ok";
    dot.classList.toggle("ok", ok);
    dot.classList.toggle("err", !ok);
    titleEl.textContent = data.status ? data.status.toUpperCase() : "UNKNOWN";
    tsEl.textContent = data.timestamp ? `Timestamp ${data.timestamp}` : "Timestamp not available";
    jsonEl.textContent = JSON.stringify(data, null, 2);
  }

  refreshBtn?.addEventListener('click', async () => {
    refreshBtn.disabled = true;
    refreshBtn.textContent = "Checking...";
    try {
      const resp = await fetch("/health");
      const body = await resp.json();
      setStatus(body);
    } catch (err) {
      setStatus({ status: "error", error: err?.message || "Failed to fetch" });
    } finally {
      refreshBtn.disabled = false;
      refreshBtn.textContent = "Re-run check";
    }
  });
</script>
{% endblock %}
